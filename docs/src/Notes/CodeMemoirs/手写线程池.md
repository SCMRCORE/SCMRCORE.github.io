---
title: "ğŸ¥½ å®ç°ç®€å•çº¿ç¨‹æ± "
desc: "çº¿ç¨‹æ± çš„æ‰‹å†™"
tags: "note"
updateTime: "2025-3-18 14:23"
---

# æ‰‹å†™çº¿ç¨‹æ± 

æ¶‰åŠå…«è‚¡ï¼šexceptionï¼ŒLockSupportï¼Œé˜»å¡é˜Ÿåˆ—ï¼Œçº¿ç¨‹æ± 

ä»“åº“é“¾æ¥ï¼š[SCMRCORE/mini-thread-pool: æ‰‹å†™ä¸€ä¸ªminiçš„çº¿ç¨‹æ± ](https://github.com/SCMRCORE/mini-thread-pool)



## åŸºç¡€å®ç°

```java
public class MyThreadPool {
    //1.çº¿ç¨‹ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ
    //2.çº¿ç¨‹çš„Runnbaleæ˜¯ä»€ä¹ˆï¼Ÿæ˜¯æˆ‘ä»¬æäº¤çš„Commandå—ï¼Ÿ
    void execute(Runnable command){
        new Thread(command).start();
    }
}
```

è¿™æ ·å†™å½“ç„¶èƒ½å®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬çº¿ç¨‹æ± å°±æ˜¯ä¸ºäº†**é¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¸¦æ¥çš„æ€§èƒ½å¼€é”€**ï¼›

å¹¶ä¸”**æ— æ³•è¿›è¡Œçº¿ç¨‹çš„æ‰‹åŠ¨ç®¡ç†**ï¼Œå³ä½¿æˆ‘ä»¬æŠŠä»»åŠ¡è£…è¿›Listï¼Œçº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä»ä¼šè‡ªåŠ¨é”€æ¯ï¼›



## å®ç°å¤ç”¨å’Œç®¡ç†(é˜»å¡é˜Ÿåˆ—)

```java
public class MyThreadPool {

    List<Runnable> commandList = new ArrayList<>();
    Thread thread = new Thread(()->{
        while(true) {
            if(!commandList.isEmpty()){
                Runnable command = commandList.remove(0);
                command.run();
            }
        }
    });

    void execute(Runnable command) {
        commandList.add(command);
    }
}
```

å’Œä¸Šä¸€æœŸçš„å®šæ—¶ä»»åŠ¡ç±»ä¼¼ï¼š

**æˆ‘ä»¬çš„executeå°†ä»»åŠ¡æ‰”è¿›å®¹å™¨ï¼Œç„¶åæˆ‘ä»¬new Threadé‡Œé¢é€šè¿‡whileå¾ªç¯ï¼Œä¸æ–­æ£€æŸ¥å®¹å™¨æ˜¯å¦ä¸ºç©º**

> **Qï¼šå¦‚æœå®¹å™¨ä¸ºç©ºï¼Œä¸€ç›´whileéå¸¸æ¶ˆè€—CPUèµ„æºï¼Œæœ‰åŠæ³•è®©å®¹å™¨ä¸ºç©ºæ—¶ä¸€ç›´é˜»å¡å—ï¼Ÿ**

æˆ‘ä»¬å¯ä»¥é€‰æ‹©é˜»å¡é˜Ÿåˆ—ï¼ŒåŒä¸Šä¸€æœŸç±»ä¼¼ï¼Œå®šæ—¶ä»»åŠ¡å®¹å™¨å¯¹é¡ºåºæœ‰è¦æ±‚ï¼Œè€Œè¿™é‡Œåªéœ€è¦åŸºç¡€çš„é˜»å¡é˜Ÿåˆ—å³å¯ï¼š

```java
public class MyThreadPool {
    //é˜»å¡é˜Ÿåˆ—ï¼Œé¿å…å…¶ä»–å®¹å™¨ç­‰å¾…æ—¶ç–¯ç‹‚æ¶ˆè€—CPUèµ„æº
    BlockingQueue<Runnable> blockingQueue = new ArrayBlockingQueue<>(1024);//éœ€è¦æŒ‡å®šå®¹é‡
    Thread thread = new Thread(()->{
        while(true) {
            try {
                Runnable command = blockingQueue.take();
                command.run();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
    }, "å”¯ä¸€çº¿ç¨‹");


    {//å¯åŠ¨çº¿ç¨‹ï¼Œåˆ›å»ºç±»æ—¶ä¼šæ‰§è¡Œ
        thread.start();
    }

    void execute(Runnable command) {
        //offeråŒºåˆ«äºaddä¼šæœ‰ä¸ªè¿”å›å€¼ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªå€¼æ¥åˆ¤æ–­
        boolean offfer =  blockingQueue.offer(command);
    }
}

```

æ‹“å±•ï¼š

**InterruptedExceptionåœ¨è¿™é‡Œçš„é€»è¾‘æ˜¯è¿è¡Œæ—¶è¢«ä¸­æ–­ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨è¿›è¡Œå¼‚å¸¸çš„catchå¤„ç†ã€‚æˆ‘ä»¬çš„sleepä¹Ÿæœ‰è¿™ä¸ªå¼‚å¸¸ï¼ŒJUCåŒ…é‡Œå‡ ä¹æ‰€æœ‰éœ€è¦ç­‰å¾…çš„æ–¹æ³•éƒ½æœ‰è¿™ä¸ªå¼‚å¸¸ï¼Œé™¤äº†locksupportçš„parkæ–¹æ³•**

åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± äº†ï¼Œç”±äºæˆ‘ä»¬çš„é˜»å¡é˜Ÿåˆ—é€»è¾‘ï¼Œä¸ä¼šè‡ªåŠ¨åœæ­¢éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åœæ­¢ï¼š

![image-20250318144716125](../../public/æ‰‹å†™çº¿ç¨‹æ± .assets/image-20250318144716125.png)	



## å®ç°æ± ä¸­çš„å¤šä¸ªçº¿ç¨‹(corePoolSize)

åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ˜¾ç„¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚

```java
public class MyThreadPool {
    //é˜»å¡é˜Ÿåˆ—ï¼Œé¿å…å…¶ä»–å®¹å™¨ç­‰å¾…æ—¶ç–¯ç‹‚æ¶ˆè€—CPUèµ„æº
    BlockingQueue<Runnable> blockingQueue = new ArrayBlockingQueue<>(1024);//éœ€è¦æŒ‡å®šå®¹é‡
    //å°†çº¿ç¨‹é‡Œçš„è¿è¡Œé€»è¾‘æå–æˆä¸€ä¸ªå…±ç”¨task
    private final Runnable task = ()->{
        while(true) {
            try {
                Runnable command = blockingQueue.take();
                command.run();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
    };
    
    private int corePoolSize = 10;
    //ç”¨å®¹å™¨å­˜å‚¨çº¿ç¨‹,æˆ‘ä»¬åº”è¯¥æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ï¼Ÿ
    List<Thread> threadList = new ArrayList<>();
    
    void execute(Runnable command) {
        //offeråŒºåˆ«äºaddä¼šæœ‰ä¸ªè¿”å›å€¼ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªå€¼æ¥åˆ¤æ–­
        boolean offfer =  blockingQueue.offer(command);
    }
}
```

å› æ­¤ï¼Œæˆ‘ä»¬å°†çº¿ç¨‹**å¤ç”¨çš„é€»è¾‘æå–æˆä¸€ä¸ªRunnable**ï¼Œå¹¶ç”¨**å®¹å™¨å­˜å‚¨çº¿ç¨‹** ï¼Œ**ç”¨corePoolSizeè¡¨ç¤ºæ•°é‡**





## å®Œå–„executeé€»è¾‘(maxSize)

å½“æˆ‘ä»¬çš„offerè¿”å›falseï¼Œä¾¿æ˜¯è¯´æ˜æˆ‘ä»¬çš„çº¿ç¨‹å·²ç»ç”¨å®Œäº†

```java
private int corePoolSize = 10;
private int maxSize = 16;

//ç”¨å®¹å™¨å­˜å‚¨çº¿ç¨‹
List<Thread> coreList = new ArrayList<>();
//æ ¸å¿ƒçº¿ç¨‹å·²æ»¡ï¼Œéœ€è¦è¾…åŠ©çº¿ç¨‹æ¥å¸®æˆ‘ä»¬å¤„ç†ä»»åŠ¡
List<Thread> supportList = new ArrayList<>();//maxSize-corePoolSize

void execute(Runnable command) {
    //åˆ¤æ–­ThreadListæœ‰å¤šå°‘å…ƒç´ ï¼Œæ²¡åˆ°corePoolSizeå°±åˆ›å»ºçº¿ç¨‹
    if(coreList.size()<corePoolSize){
        Thread thread = new Thread(task);
        coreList.add(thread);
        thread.start();
    }
    //offeråŒºåˆ«äºaddä¼šæœ‰ä¸ªè¿”å›å€¼ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªå€¼æ¥åˆ¤æ–­
    if(!blockingQueue.offer(command)){
        Thread thread =new Thread(task);
        supportList.add(thread);
        thread.start();
    }
}
```

è¿™é‡Œä¾¿å¼•å…¥äº†maxSizeï¼Œæ ¸å¿ƒçº¿ç¨‹å·²æ»¡ï¼Œéœ€è¦è¾…åŠ©çº¿ç¨‹æ¥å¸®æˆ‘ä»¬å¤„ç†ä»»åŠ¡ï¼Œç”¨supportListæ¥å­˜

> **Qï¼šå¦‚æœè¾…åŠ©çº¿ç¨‹ä¹Ÿæ»¡äº†æ€ä¹ˆåŠå‘¢ï¼ŸåŒæ—¶æˆ‘ä»¬è¿™é‡Œæ“ä½œä¸æ˜¯åŸå­çš„ï¼Œæ¶‰åŠçº¿ç¨‹å®‰å…¨é—®é¢˜**

PSï¼šæ¼”ç¤ºdemoå°±ä¸è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜äº†(CASå’Œé”)ï¼Œä½†æ˜¯æˆ‘ä»¬è¦çŸ¥é“

å†å®Œå–„ä¸‹execute

```java
private int corePoolSize = 10;
private int maxSize = 16;
//ç”¨å®¹å™¨å­˜å‚¨çº¿ç¨‹
List<Thread> coreList = new ArrayList<>();
//æ ¸å¿ƒçº¿ç¨‹å·²æ»¡ï¼Œéœ€è¦è¾…åŠ©çº¿ç¨‹æ¥å¸®æˆ‘ä»¬å¤„ç†ä»»åŠ¡
List<Thread> supportList = new ArrayList<>();//maxSize-corePoolSize
void execute(Runnable command) {
    //åˆ¤æ–­ThreadListæœ‰å¤šå°‘å…ƒç´ ï¼Œæ²¡åˆ°corePoolSizeå°±åˆ›å»ºçº¿ç¨‹
    if(coreList.size()<corePoolSize){
        Thread thread = new Thread(task);
        coreList.add(thread);
        thread.start();
    }
    //offeråŒºåˆ«äºaddä¼šæœ‰ä¸ªè¿”å›å€¼ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªå€¼æ¥åˆ¤æ–­
    if(blockingQueue.offer(command)) return;

    if(coreList.size() + supportList.size() < maxSize){
        Thread thread =new Thread(task);
        supportList.add(thread);
        thread.start();
    }
    //åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå› ä¸ºä¸æ˜¯åŸå­å³ä½¿åˆšåˆ›å»ºï¼Œä¹Ÿå¯èƒ½æ»¡
    if(!blockingQueue.offer(command)){
        throw new RuntimeException("é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼")
    }
}
```



## ä¼˜åŒ–:è¾…åŠ©çº¿ç¨‹ç©ºé—²é‡Šæ”¾

ä¸€ä¸ªçº¿ç¨‹å¦‚ä½•è®©è‡ªå·±åœ¨ç©ºé—²çš„æ—¶å€™ç»“æŸå‘¢ï¼Ÿ

**æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡äº†è¶…æ—¶æ—¶é—´ä»ç„¶æ²¡æ‹¿åˆ°ä»»åŠ¡ï¼Œè¯´æ˜æ­¤æ—¶çš„çº¿ç¨‹æ± ä¸å¿™ç¢Œ**ï¼Œè¾…åŠ©çº¿ç¨‹å°±åº”è¯¥è‡ªå·±ç»“æŸã€‚

è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹**BlockingQueueçš„API**ï¼Œpollå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œè¶…æ—¶æ—¶é—´å’Œå•ä½ï¼Œä¹Ÿå°±æ˜¯è¶…è¿‡æ—¶é—´ä»ç„¶æ²¡æ‹¿åˆ°åˆ™è¿”å›null

![image-20250318151735202](../../public/æ‰‹å†™çº¿ç¨‹æ± .assets/image-20250318151735202.png)	

å› æ­¤ï¼Œä¿®æ”¹æˆ‘ä»¬çš„taské€»è¾‘ï¼Œå°†æ ¸å¿ƒçº¿ç¨‹å’Œè¾…åŠ©çº¿ç¨‹åˆ†å¼€ï¼Œexecuteé‡Œè®°å¾—æ”¹ä¸‹å‚æ•°åï¼Œè¿™é‡Œå°±ä¸æ¼”ç¤ºäº†

```java
//å°†çº¿ç¨‹é‡Œçš„è¿è¡Œé€»è¾‘æå–æˆä¸€ä¸ªå…±ç”¨task
private final Runnable coreTask = ()->{
    while(true) {
        try {
            Runnable command = blockingQueue.take();
            command.run();
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }
};
//æ ¸å¿ƒçº¿ç¨‹ä»»åŠ¡å’Œè¾…åŠ©çº¿ç¨‹ä»»åŠ¡è¦åšä¸€ä¸ªåŒºåˆ†
private final Runnable supportTask = ()->{
    while(true) {
        try {
            Runnable command = blockingQueue.poll(1, TimeUnit.SECONDS);
            if(command==null) {
                break;//å¦‚æœæ²¡nullè¯´æ˜ç©ºé—²ï¼Œbreakåä¼šè‡ªåŠ¨æ¨å‡ºå¾ªç¯ï¼Œçº¿ç¨‹ç»“æŸ
            }
            command.run();
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }
    System.out.println(Thread.currentThread().getName()+"çº¿ç¨‹ç»“æŸäº†!");
};
```



## ä¼˜åŒ–ï¼šè¶…æ—¶æ—¶é—´å¦‚ä½•è®¾ç½®(timeoutå’ŒtimeUnit)

æˆ‘ä»¬ä¹Ÿå¾—çŸ¥é“å…·ä½“è®¾ç½®å¤šå°‘è¶…æ—¶æ—¶é—´ï¼Œäºæ˜¯å°†ä¸¤ä¸ªå‚æ•°timeoutå’ŒtimeUnitå•ç‹¬åˆ—å‡ºæ¥ï¼Œæ”¾å…¥æ„é€ å‡½æ•°

```java
private int corePoolSize;
private int maxSize;
private int timeout;
private TimeUnit timeUnit;

public MyThreadPool(int corePoolSize, int maxSize, int timeout, TimeUnit timeUnit){
    this.corePoolSize = corePoolSize;
    this.maxSize = maxSize;
    this.timeout = timeout;
    this.timeUnit = timeUnit;
}
```

åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸¤ä¸ªtaskå°è£…æˆä¸¤ä¸ªç±»

```java
//å°†çº¿ç¨‹é‡Œçš„è¿è¡Œé€»è¾‘æå–æˆä¸€ä¸ªå…±ç”¨task,å¹¶ä¸”å¯ä»¥å°†ä¸¤ä¸ªtaskå°è£…ä¸ºç±»æ–¹ä¾¿è°ƒç”¨
class CoreThread extends Thread{
    @Override
    public void run() {
        while(true) {
            try {
                Runnable command = blockingQueue.take();
                command.run();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
    }
}
class SupportThread extends Thread{
    @Override
    public void run() {
        while(true) {
            try {
                Runnable command = blockingQueue.poll(timeout, timeUnit);
                if(command==null) {
                    break;//å¦‚æœæ²¡nullè¯´æ˜ç©ºé—²ï¼Œbreakåä¼šè‡ªåŠ¨æ¨å‡ºå¾ªç¯ï¼Œçº¿ç¨‹ç»“æŸ
                }
                command.run();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        System.out.println(Thread.currentThread().getName()+"çº¿ç¨‹ç»“æŸäº†!");
    }
}
```

åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠé˜»å¡é˜Ÿåˆ—æ”¾å…¥æ„é€ å‡½æ•°ï¼Œè®©ç”¨æˆ·è‡ªå·±å®šä¹‰

```java
private int corePoolSize;
private int maxSize;
private int timeout;
private TimeUnit timeUnit;
//é˜»å¡é˜Ÿåˆ—ï¼Œé¿å…å…¶ä»–å®¹å™¨ç­‰å¾…æ—¶ç–¯ç‹‚æ¶ˆè€—CPUèµ„æº
BlockingQueue<Runnable> blockingQueue;//ç”¨æˆ·ä¼ å…¥æ—¶éœ€è¦æŒ‡å®šå®¹é‡

public MyThreadPool(int corePoolSize, int maxSize, int timeout, TimeUnit timeUnit, BlockingQueue<Runnable> blockingQueue){
    this.corePoolSize = corePoolSize;
    this.maxSize = maxSize;
    this.timeout = timeout;
    this.timeUnit = timeUnit;
    this.blockingQueue = blockingQueue;//éœ€è¦æŒ‡å®šå®¹é‡
}
```

æµ‹è¯•ç”¨ä¾‹ï¼š

```java
@SpringBootApplication
public class ThreadPoolApplication {

    public static void main(String[] args) {
        MyThreadPool myThreadPool = new MyThreadPool(2, 4, 1, TimeUnit.SECONDS, new ArrayBlockingQueue<>(2));
        for (int i = 0; i < 5; i++) {
            myThreadPool.execute(()->{
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                System.out.println(Thread.currentThread().getName());
            });
        }
        System.out.println("ä¸»çº¿ç¨‹æ²¡æœ‰è¢«é˜»å¡");
    }

}
//TODO æ— æ³•å¤ç°è§†é¢‘é‡Œçš„
```





## æ‹’ç»ç­–ç•¥(Handler)

é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠ›å¼‚å¸¸ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæŠ›å¼‚å¸¸å•ç‹¬æ‹¿å‡ºæ¥ï¼Œç»„åˆæˆä¸€ä¸ªæ‹’ç»ç­–ç•¥ã€‚

ç”Ÿæˆä¸€ä¸ªrejectæ¥å£ï¼Œå…·ä½“çš„å¼‚å¸¸ï¼Œåªéœ€è¦å®ç°è¿™ä¸ªæ¥å£å³å¯

```java
public interface RejectHandle {
    //æ‹’ç»ç­–ç•¥çš„è¯ï¼Œæˆ‘ä»¬è‚¯å®šè¦ä»»åŠ¡ä¿¡æ¯å’Œçº¿ç¨‹æ± çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ä¼ å…¥è¿™ä¿©
    void reject(Runnable rejectCommand, MyThreadPool myThreadPool);
}
```

åŒæ ·æ˜¯è£…å…¥æ„é€ å‡½æ•°

```java
private int corePoolSize;
private int maxSize;
private int timeout;
private TimeUnit timeUnit;
//é˜»å¡é˜Ÿåˆ—ï¼Œé¿å…å…¶ä»–å®¹å™¨ç­‰å¾…æ—¶ç–¯ç‹‚æ¶ˆè€—CPUèµ„æº
BlockingQueue<Runnable> blockingQueue;//ç”¨æˆ·ä¼ å…¥æ—¶éœ€è¦æŒ‡å®šå®¹é‡
private final RejectHandle rejectHandle;

public MyThreadPool(int corePoolSize, int maxSize, int timeout, TimeUnit timeUnit, BlockingQueue<Runnable> blockingQueue, RejectHandle rejectHandle) {
    this.corePoolSize = corePoolSize;
    this.maxSize = maxSize;
    this.timeout = timeout;
    this.timeUnit = timeUnit;
    this.blockingQueue = blockingQueue;//éœ€è¦æŒ‡å®šå®¹é‡
    this.rejectHandle=rejectHandle;
}
```

å¹¶ä¸”åœ¨executeé‡ŒæŠŠthrowæ›¿æ¢æˆreject

```java
void execute(Runnable command) {
    //åˆ¤æ–­ThreadListæœ‰å¤šå°‘å…ƒç´ ï¼Œæ²¡åˆ°corePoolSizeå°±åˆ›å»ºçº¿ç¨‹
    if(coreList.size()<corePoolSize){
        Thread thread = new CoreThread();
        coreList.add(thread);
        thread.start();
    }
    //offeråŒºåˆ«äºaddä¼šæœ‰ä¸ªè¿”å›å€¼ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªå€¼æ¥åˆ¤æ–­
    if(blockingQueue.offer(command)) return;

    if(coreList.size() + supportList.size() < maxSize){
        Thread thread =new SupportThread();
        supportList.add(thread);
        thread.start();
    }
    //åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå› ä¸ºä¸æ˜¯åŸå­å³ä½¿åˆšåˆ›å»ºï¼Œä¹Ÿå¯èƒ½æ»¡
    if(!blockingQueue.offer(command)){
        rejectHandle.reject(command, this);
    }
}
```

å®ç°è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥

```java
public class ThrowRejectHandler implements RejectHandle{
    @Override
    public void reject(Runnable rejectCommand, MyThreadPool myThreadPool) {
        throw new RuntimeException("é˜»å¡é˜Ÿåˆ—å·²æ»¡");
    }
}
```

æµ‹è¯•ï¼š

```java
@SpringBootApplication
public class ThreadPoolApplication {

    public static void main(String[] args) {
        MyThreadPool myThreadPool = new MyThreadPool(2, 4, 1, TimeUnit.SECONDS, new ArrayBlockingQueue<>(2), new ThrowRejectHandler());
        for (int i = 0; i < 5; i++) {
            myThreadPool.execute(()->{
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                System.out.println(Thread.currentThread().getName());
            });
        }
        System.out.println("ä¸»çº¿ç¨‹æ²¡æœ‰è¢«é˜»å¡");
    }

}
```



## å®Œæ•´ä»£ç 

**MyThreadPool**

```java
public class MyThreadPool {

    private int corePoolSize;
    private int maxSize;
    private int timeout;
    private TimeUnit timeUnit;
    //é˜»å¡é˜Ÿåˆ—ï¼Œé¿å…å…¶ä»–å®¹å™¨ç­‰å¾…æ—¶ç–¯ç‹‚æ¶ˆè€—CPUèµ„æº
    BlockingQueue<Runnable> blockingQueue;//ç”¨æˆ·ä¼ å…¥æ—¶éœ€è¦æŒ‡å®šå®¹é‡
    private final RejectHandle rejectHandle;

    public MyThreadPool(int corePoolSize, int maxSize, int timeout, TimeUnit timeUnit, BlockingQueue<Runnable> blockingQueue, RejectHandle rejectHandle) {
        this.corePoolSize = corePoolSize;
        this.maxSize = maxSize;
        this.timeout = timeout;
        this.timeUnit = timeUnit;
        this.blockingQueue = blockingQueue;//éœ€è¦æŒ‡å®šå®¹é‡
        this.rejectHandle=rejectHandle;
    }

    //çœç•¥getæ–¹æ³•

    //ç”¨å®¹å™¨å­˜å‚¨çº¿ç¨‹
    List<Thread> coreList = new ArrayList<>();
    //æ ¸å¿ƒçº¿ç¨‹å·²æ»¡ï¼Œéœ€è¦è¾…åŠ©çº¿ç¨‹æ¥å¸®æˆ‘ä»¬å¤„ç†ä»»åŠ¡
    List<Thread> supportList = new ArrayList<>();//maxSize-corePoolSize

    void execute(Runnable command) {
        //åˆ¤æ–­ThreadListæœ‰å¤šå°‘å…ƒç´ ï¼Œæ²¡åˆ°corePoolSizeå°±åˆ›å»ºçº¿ç¨‹
        if(coreList.size()<corePoolSize){
            Thread thread = new CoreThread();
            coreList.add(thread);
            thread.start();
        }
        //offeråŒºåˆ«äºaddä¼šæœ‰ä¸ªè¿”å›å€¼ï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°è¿™ä¸ªå€¼æ¥åˆ¤æ–­
        if(blockingQueue.offer(command)) return;

        if(coreList.size() + supportList.size() < maxSize){
            Thread thread =new SupportThread();
            supportList.add(thread);
            thread.start();
        }
        //åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå› ä¸ºä¸æ˜¯åŸå­å³ä½¿åˆšåˆ›å»ºï¼Œä¹Ÿå¯èƒ½æ»¡
        if(!blockingQueue.offer(command)){
            rejectHandle.reject(command, this);
        }
    }

    //å°†çº¿ç¨‹é‡Œçš„è¿è¡Œé€»è¾‘æå–æˆä¸€ä¸ªå…±ç”¨task,å¹¶ä¸”å¯ä»¥å°†ä¸¤ä¸ªtaskå°è£…ä¸ºç±»æ–¹ä¾¿è°ƒç”¨
    class CoreThread extends Thread{
        @Override
        public void run() {
            while(true) {
                try {
                    Runnable command = blockingQueue.take();
                    command.run();
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
            }
        }
    }
    class SupportThread extends Thread{
        @Override
        public void run() {
            while(true) {
                try {
                    Runnable command = blockingQueue.poll(timeout, timeUnit);
                    if(command==null) {
                        break;//å¦‚æœæ²¡nullè¯´æ˜ç©ºé—²ï¼Œbreakåä¼šè‡ªåŠ¨æ¨å‡ºå¾ªç¯ï¼Œçº¿ç¨‹ç»“æŸ
                    }
                    command.run();
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
            }
            System.out.println(Thread.currentThread().getName()+"çº¿ç¨‹ç»“æŸäº†!");
        }
    }
}
```

**RejectHandler**

```java
public interface RejectHandle {
    //æ‹’ç»ç­–ç•¥çš„è¯ï¼Œæˆ‘ä»¬è‚¯å®šè¦ä»»åŠ¡ä¿¡æ¯å’Œçº¿ç¨‹æ± çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ä¼ å…¥è¿™ä¿©
    void reject(Runnable rejectCommand, MyThreadPool myThreadPool);
}
```

**ThrowRejectHandler**

```java
public class ThrowRejectHandler implements RejectHandle{
    @Override
    public void reject(Runnable rejectCommand, MyThreadPool myThreadPool) {
        throw new RuntimeException("é˜»å¡é˜Ÿåˆ—å·²æ»¡");
    }
}
```

**test**

```java
@SpringBootApplication
public class ThreadPoolApplication {

    public static void main(String[] args) {
        MyThreadPool myThreadPool = new MyThreadPool(2, 4, 1, TimeUnit.SECONDS, new ArrayBlockingQueue<>(2), new ThrowRejectHandler());
        for (int i = 0; i < 4; i++) {
            myThreadPool.execute(()->{
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
                System.out.println(Thread.currentThread().getName());
            });
        }
        System.out.println("ä¸»çº¿ç¨‹æ²¡æœ‰è¢«é˜»å¡");
    }
}
```



## æ€è€ƒ

- æ¼”ç¤ºdemoå°±æ²¡æœ‰ä¿è¯executeçš„åŸå­æ€§ï¼Œå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜
- çº¿ç¨‹æ± ç¼ºå°‘shutdownåŠŸèƒ½ï¼Œèƒ½å¢åŠ å—ï¼Ÿ
- é—®ï¼šæ€ä¹ˆç†è§£æ‹’ç»ç­–ç•¥ï¼Ÿè¯¥å¦‚ä½•å›ç­”ï¼Ÿ
- JDKçº¿ç¨‹æ± è¿˜æœ‰ä¸ªThreadFactoryå‚æ•°ï¼Œå¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ